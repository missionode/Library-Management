{% extends 'base.html' %}

{% block content %}
<div class="mb-8 flex justify-between items-center">
    <h1 class="text-3xl font-bold text-gray-900">Member Management</h1>
</div>

<!-- Search Bar -->
<div class="mb-8">
    <form method="get" class="flex gap-2">
        <input type="text" name="q" placeholder="Search members by name, email, or username..." value="{{ request.GET.q }}"
               class="flex-grow border border-gray-300 rounded-lg px-4 py-2 focus:ring-2 focus:ring-primary">
        <button type="submit" class="bg-primary text-white px-6 py-2 rounded-lg hover:bg-[#142f29] transition">Search</button>
    </form>
</div>

<!-- Member List Table -->
<div class="bg-white shadow overflow-hidden sm:rounded-lg border">
    <table class="min-w-full divide-y divide-gray-200">
        <thead class="bg-gray-50">
            <tr>
                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">User</th>
                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Subscription</th>
                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
            </tr>
        </thead>
        <tbody class="bg-white divide-y divide-gray-200">
            {% for member in members %}
                <tr>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <div class="flex items-center">
                            <div class="flex-shrink-0 h-10 w-10 bg-gray-200 rounded-full flex items-center justify-center text-gray-500">
                                {{ member.username|slice:":1"|upper }}
                            </div>
                            <div class="ml-4">
                                <div class="text-sm font-medium text-gray-900">{{ member.get_full_name|default:member.username }}</div>
                                <div class="text-sm text-gray-500">{{ member.email }}</div>
                            </div>
                        </div>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <form action="{% url 'change_membership' member.pk %}" method="post" class="flex items-center space-x-2">
                            {% csrf_token %}
                            <select name="tier_id" onchange="this.form.submit()" class="text-sm border-gray-300 rounded-md">
                                {% for tier in tiers %}
                                    <option value="{{ tier.id }}" {% if member.membership_tier_id == tier.id %}selected{% endif %}>
                                        {{ tier.name }}
                                    </option>
                                {% endfor %}
                            </select>
                        </form>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full {% if member.is_active_member %}bg-green-100 text-green-800{% else %}bg-red-100 text-red-800{% endif %}">
                            {{ member.is_active_member|yesno:"Active,Blocked" }}
                        </span>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                        <form action="{% url 'toggle_member_status' member.pk %}" method="post" class="inline">
                            {% csrf_token %}
                            <button type="submit" class="{% if member.is_active_member %}text-red-600 hover:text-red-900{% else %}text-green-600 hover:text-green-900{% endif %}">
                                {{ member.is_active_member|yesno:"Block,Unblock" }}
                            </button>
                        </form>
                    </td>
                </tr>
            {% empty %}
                <tr>
                    <td colspan="4" class="px-6 py-10 text-center text-gray-500">No members found.</td>
                </tr>
            {% endfor %}
        </tbody>
    </table>
</div>

<!-- Pagination -->
{% if is_paginated %}
    <div class="mt-4 flex justify-center space-x-2">
        {% if page_obj.has_previous %}
            <a href="?page={{ page_obj.previous_page_number }}{% if request.GET.q %}&q={{ request.GET.q }}{% endif %}" class="px-4 py-2 border rounded hover:bg-gray-50">Previous</a>
        {% endif %}
        <span class="px-4 py-2 text-gray-600">Page {{ page_obj.number }} of {{ page_obj.paginator.num_pages }}</span>
        {% if page_obj.has_next %}
            <a href="?page={{ page_obj.next_page_number }}{% if request.GET.q %}&q={{ request.GET.q }}{% endif %}" class="px-4 py-2 border rounded hover:bg-gray-50">Next</a>
        {% endif %}
    </div>
{% endif %}
{% endblock %}
